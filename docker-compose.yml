version: '2'

services:
  db:
    image: mysql:5.6
    volumes:
      - db_data:/var/lib/mysql
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    restart: always
    env_file: database.properties
    environment:
      MYSQL_DATABASE: kontalk
      MYSQL_USER: kontalk

  tigase:
    depends_on:
      - db
    image: kontalk/xmppserver
    ports:
      - "5222:5222"
      - "5269:5269"
    volumes:
      - tigase_data:/home/kontalk/data
      - ./data:/tmp/data
      - ./data/tigase.conf:/home/kontalk/kontalk/tigase-kontalk/etc/tigase.conf
      - ./data/trusted.pem:/home/kontalk/kontalk/tigase-kontalk/trusted.pem
    restart: always
    env_file: tigase.properties
    environment:
      MYSQL_DATABASE: kontalk
      MYSQL_USER: kontalk

  httpupload:
    image: kontalk/httpupload
    ports:
      - "8828:8828"
    volumes:
      - httpupload_data:/home/kontalk/disk
      - ./data/config.yml.in:/tmp/config.yml.in
    restart: always
    env_file: tigase.properties

volumes:
  db_data:
  tigase_data:
  httpupload_data:
